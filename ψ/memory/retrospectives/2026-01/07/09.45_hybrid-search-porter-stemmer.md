# Session Retrospective: Hybrid Search & Porter Stemmer

**Date**: 2026-01-07 09:45 GMT+7
**Duration**: ~45 minutes
**Branch**: main

## What Was Done

### 1. Always Hybrid Search for Consult
- Changed `/consult` from "vector fallback" to "always hybrid"
- Runs both FTS5 and vector search in parallel
- Merges results with score boost for appearing in both sources
- Files: `src/server/handlers.ts`

### 2. Porter Stemmer for FTS5
- Added `tokenize='porter unicode61'` to FTS5 table
- Enables "tire" and "tired" to match same documents
- Created `/fts-rebuild` endpoint for migration
- Rebuilt 6644 documents with new stemmer
- Files: `src/db/index.ts`, `src/indexer.ts`, `src/server.ts`

### 3. UI Source & Score Display
- Added colored badges: `fts` (blue), `vector` (purple), `hybrid` (green)
- Shows relevance score as percentage
- Files: `frontend/src/pages/Consult.tsx`, `Consult.module.css`

### 4. Reusable Server Utils
- Created `asyncHandlerWithValidation` utility
- Combines async handler + required param validation
- Used in `/search` and `/consult` endpoints
- Files: `src/server/utils.ts`, `src/server.ts`

## Key Discoveries

### FTS5 Stemming
- FTS5 by default does NOT stem words
- "tired" and "tire" are different tokens without Porter
- Adding `tokenize='porter unicode61'` enables stemming
- Requires table rebuild (DROP + CREATE + re-insert)

### Hybrid Scoring
- Original approach: average scores - penalized good matches
- Better approach: `max(fts, vector) + 0.1 bonus`
- Bonus rewards appearing in both search types

## AI Diary

This session felt like natural evolution of the vector search work from earlier. The user noticed "tire" vs "tired" gave different results - a perfect example of why FTS5's exact matching isn't always what you want.

I enjoyed implementing the Porter stemmer - it's one of those classic CS algorithms that just works. The `/fts-rebuild` endpoint was a practical touch for migrating existing data.

The UI badges were satisfying to add. Being able to see "fts" vs "vector" vs "hybrid" makes the search behavior transparent. The user can now understand WHY certain results appear.

## Honest Feedback

**What Worked:**
- Incremental approach: first hybrid, then stemmer, then UI
- The `/fts-rebuild` endpoint was smart - avoid forcing full reindex
- Color-coded badges are immediately understandable

**What Could Be Better:**
- Should have tested Porter stemmer effect before claiming it was done
- The "tire" search still shows mostly vector results - need to verify FTS is actually finding stemmed matches
- Could add stemmer test to unit tests

## Files Changed

```
frontend/src/api/oracle.ts         - Added score/source types
frontend/src/pages/Consult.tsx     - Added badges and scores
frontend/src/pages/Consult.module.css - Badge styles
src/db/index.ts                    - Porter stemmer + rebuild function
src/indexer.ts                     - Porter stemmer for new DBs
src/server.ts                      - /fts-rebuild endpoint
src/server/handlers.ts             - Always hybrid consult
src/server/utils.ts                - NEW: async handler utility
```

## Next Steps

- Verify Porter stemmer is working correctly with test queries
- Add stemmer effectiveness to /stats endpoint
- Consider adding stemmer toggle for exact vs fuzzy matching

## Tags

`fts5` `porter-stemmer` `hybrid-search` `vector` `ui` `consult`
