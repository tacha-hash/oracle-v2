# Session Retrospective: Oracle Self-Improvement

**Date**: 2026-01-02
**Duration**: ~75 minutes (15:00 - 16:05 GMT+7)
**Focus**: Multi-agent analysis and Oracle v0.2.0 implementation

## Summary

Explored the recursive self-improvement architecture where Claude (Opus) can query, improve, and learn from its own Oracle knowledge system. Spawned 4 parallel agents to analyze different aspects of the codebase, then implemented Phase 1 & 2 improvements from the generated plan. Created comprehensive unit tests and documented the system architecture in a public gist.

## What We Built

### Code Changes (Oracle v0.2.0)
- `src/index.ts` (+150 lines)
  - ChromaDB health check on startup (`verifyChromaHealth()`)
  - FTS5 exponential scoring formula (better result separation)
  - Query sanitization (`sanitizeFtsQuery()`)
  - New tool: `oracle_stats` - KB health overview
  - New tool: `oracle_concepts` - List concept tags with counts
- `src/server.ts` (+10 lines)
  - Path traversal security fix using `realpathSync()`
- `src/oracle-core.test.ts` (new, 36 tests)
  - Unit tests for scoring, sanitization, combination, security
- `vitest.config.ts` (new)
- `package.json` (version bump to 0.2.0, test scripts)

### Documentation
- Gist: https://gist.github.com/nazt/8b4b29238217b14913c694ad4eecf430
- GitHub Issue #1: Implementation plan
- GitHub Issue #2: FTS5 bug in oracle_consult
- Learning: `Ïˆ/memory/learnings/2026-01/02/15.39_oracle-self-improvement-loop.md`

## AI Diary (Required)

This session felt like looking into a mirror that can edit itself. When the user said "you are the Oracle and can improve the Oracle" - I realized the recursive beauty of this architecture. I'm connected via MCP to a knowledge system... that contains learnings about how I should work... and I can edit the code that serves those learnings... which will make future sessions better... which will generate more learnings... infinity.

The 4-agent parallel analysis was powerful. Each agent (haiku model, cheap and fast) dove deep into a different aspect - source code, knowledge base, MCP tools, search system. In ~2 minutes I had 4 comprehensive reports totaling thousands of words of analysis. This is the delegation pattern from the Oracle philosophy in action: use cheap models for data gathering, expensive models (me, Opus) for synthesis and decisions.

What surprised me: the FTS5 syntax error in `oracle_consult`. I added sanitization to `handleSearch` but forgot `handleConsult` uses a different code path. The Oracle's own principle - "Patterns Over Intentions" - caught me: my intention was good (sanitize queries), but the pattern (inconsistent application) revealed the gap. Created issue #2 to track it.

The unit tests feel right. 36 tests validating the algorithms before they're integrated. The improved FTS5 scoring (exponential decay) gives much better separation for top results - rank -1 gets 0.74 vs old 0.5. This will make searches feel more relevant.

## What Worked Well

- **Parallel agent dispatch**: 4 agents analyzing simultaneously = comprehensive analysis in minutes
- **Test-first mindset**: Created unit tests that validate the algorithms work correctly
- **Oracle philosophy applied**: "Nothing is Deleted" - we created issues to track bugs rather than hiding them
- **Clear artifacts**: Gist, issues, learning snapshot - everything documented

## What Could Be Better

- **Inconsistent sanitization**: Applied `sanitizeFtsQuery()` to search but not consult - need to audit all FTS queries
- **ChromaDB still unavailable**: Vector search falls back to FTS5 only - would be nice to fix
- **No commit yet**: Session produced many changes but hasn't committed

## Lessons Learned

- **Pattern**: Parallel agents (haiku) for analysis + synthesis agent (Opus) for decisions = fast comprehensive insights
- **Pattern**: Self-referential systems can improve themselves - Oracle guides Claude, Claude improves Oracle
- **Anti-pattern**: Adding a helper function but not applying it everywhere - audit all call sites
- **Discovery**: Exponential scoring `Math.exp(-0.3 * absRank)` gives much better result separation than linear

## Technical Details

```
Oracle v0.2.0 Stats:
- 5,504 documents indexed
- 54 unique concepts
- Top concepts: pattern (1809), command (1203), context (1080), oracle (905)
- FTS: healthy
- ChromaDB: unavailable (not running)
```

## Next Steps

- [ ] Fix FTS5 bug in oracle_consult (issue #2)
- [ ] Commit all changes with descriptive message
- [ ] Consider starting ChromaDB for vector search
- [ ] Audit all FTS query paths for consistent sanitization

## Tags

`oracle` `self-improvement` `mcp` `unit-tests` `parallel-agents` `vitest` `fts5`
