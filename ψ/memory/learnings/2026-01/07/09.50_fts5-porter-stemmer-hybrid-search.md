# FTS5 Porter Stemmer + Hybrid Search Pattern

**Date**: 2026-01-07
**Context**: User asked why "tired" found results but "tire" didn't

## The Problem

FTS5 by default uses exact token matching:
- "tired" → matches documents containing "tired"
- "tire" → matches documents containing "tire"

These are treated as completely different words. No stemming = no fuzzy matching.

## The Solution

### 1. Add Porter Stemmer to FTS5

```sql
-- Without stemmer (default)
CREATE VIRTUAL TABLE oracle_fts USING fts5(
  id UNINDEXED,
  content,
  concepts
);

-- With Porter stemmer
CREATE VIRTUAL TABLE oracle_fts USING fts5(
  id UNINDEXED,
  content,
  concepts,
  tokenize='porter unicode61'
);
```

Porter stemmer reduces words to their root:
- "tired" → "tire"
- "tire" → "tire"
- "tiring" → "tire"

### 2. Migration for Existing Data

Can't just alter the table - need to rebuild:

```typescript
export function rebuildFts5WithStemmer() {
  // Backup existing data
  const existingData = sqlite.prepare('SELECT id, content, concepts FROM oracle_fts').all();

  // Drop and recreate with stemmer
  sqlite.exec('DROP TABLE IF EXISTS oracle_fts');
  sqlite.exec(`CREATE VIRTUAL TABLE oracle_fts USING fts5(
    id UNINDEXED, content, concepts,
    tokenize='porter unicode61'
  )`);

  // Re-insert
  for (const row of existingData) {
    insertStmt.run(row.id, row.content, row.concepts);
  }
}
```

### 3. Always Hybrid (FTS + Vector)

Don't just use vector as fallback - run both:

```typescript
// Run FTS and vector in parallel
const ftsPrinciples = db.prepare('...').all(safeQuery);
const vectorResults = await chromaClient.query(query, 15);

// Merge with score boost
const merged = mergeResults(fts, vector);
// Documents in BOTH get +0.1 bonus and "hybrid" source tag
```

## Why It Matters

| Search Type | Strengths | Weaknesses |
|-------------|-----------|------------|
| FTS5 | Fast, exact matches | No semantic understanding |
| FTS5 + Porter | Fuzzy word matching | Still keyword-based |
| Vector | Semantic similarity | Slower, less precise |
| Hybrid | Best of both | More complex |

## Tags

`fts5` `porter` `stemming` `hybrid-search` `sqlite` `vector`
