# MCP-in-MCP Stdio Conflict Pattern

**Date**: 2026-01-07
**Context**: Fixing vector search in Oracle MCP server - ChromaMcpClient couldn't work inside MCP server

## What We Learned

- **MCP servers use stdio** for communication with Claude Code
- **chroma-mcp subprocess also needs stdio** to spawn Python process
- Running MCP-in-MCP causes stdio conflict → "Not connected" errors
- **Solution**: Delegate to HTTP service layer (not MCP) which has no stdio constraints

```
❌ MCP Server → ChromaMcpClient → chroma-mcp (stdio conflict!)
✅ MCP Server → HTTP Server → ChromaMcpClient → chroma-mcp (works!)
```

## Why It Matters

- Any MCP tool that spawns subprocesses via stdio will face this
- HTTP servers are "safe zones" for subprocess-heavy operations
- claude-mem solved this same problem with worker/service layer pattern

## How To Apply

```typescript
// In HTTP server handlers (safe):
const client = getChromaClient();
const results = await client.query(query, limit);

// In MCP server (avoid subprocess calls):
// Delegate to HTTP endpoint instead
const response = await fetch(`http://localhost:37778/search?q=${query}`);
```

## Related

- claude-mem's ChromaSync service pattern
- Oracle HTTP server on port 37778
- ChromaMcpClient with auto-reconnect

## Tags

`mcp` `stdio` `chroma` `vector-search` `architecture` `pattern`
